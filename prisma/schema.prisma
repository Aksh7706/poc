// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model App {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  metadata    Json?

  User     User[]
  Provider Provider[]
  Event    Event[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([name])
}

model User {
  id            String             @id @default(uuid())
  walletAddress String             @map("wallet_address")
  mobile        String?
  email         String?
  telegramData  TelegramProvider[]
  fcmToken      String[]           @map("fcm_token")
  metadata      Json?
  app           App                @relation(fields: [appName], references: [name], onDelete: Cascade)
  appName       String             @map("app_name")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([walletAddress, appName])
  @@index([walletAddress, appName])
}

model TelegramProvider {
  walletAddress String
  appName       String
  providerName  String
  chatId        String
  user          User   @relation(fields: [walletAddress, appName], references: [walletAddress, appName], onDelete: Cascade)

  @@unique([walletAddress, appName, providerName])
}

model Event {
  id                 String           @id @default(uuid())
  name               String
  template           String
  metadata           Json?
  connectedProviders EventProviders[]
  app                App              @relation(fields: [appName], references: [name], onDelete: Cascade)
  appName            String           @map("app_name")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  @@unique([name, appName])
  @@index([name, appName])
}

model EventProviders {
  appName      String
  eventName    String
  provider     Provider @relation(fields: [providerName, appName], references: [name, appName], onDelete: Cascade)
  Event        Event    @relation(fields: [eventName, appName], references: [name, appName], onDelete: Cascade)
  providerName String

  @@unique([appName, eventName, providerName])
}

model Provider {
  id             String           @id @default(uuid())
  name           String
  description    String?
  config         Json?
  channel        Channel
  providerKey    ProviderKey      @map("provider_key")
  statusCallback String?          @map("status_callback")
  app            App              @relation(fields: [appName], references: [name], onDelete: Cascade)
  appName        String           @map("app_name")
  EventProviders EventProviders[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([name, appName])
  @@index([name, appName])
}

enum Channel {
  PUSH   @map("push")
  IN_APP @map("in_app")
  OTHER  @map("other")
}

enum ProviderKey {
  // Push Provider
  FIREBASE @map("firebase")

  // In App Provider
  PIGEON_WEB    @map("pigeon_web") // Our native InApp Provider for Web Platforms
  PIGEON_MOBILE @map("pigeon_mobile") // Our native InApp Provider for Mobile Platforms

  // Other Provider
  TELEGRAM @map("telegram")
  SLACK    @map("slack")
}

model InAppWebNotifications {
  id               String  @id @default(uuid())
  appName          String
  userWalletAdress String  @map("user_wallet_address")
  message          String
  isRead           Boolean
}
